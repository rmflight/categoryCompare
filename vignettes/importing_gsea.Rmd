<!--
  %\VignetteEngine{knitr}
  %\VignetteIndexEntry{Importing GSEA}
  %\VignetteDepends{categoryComparePaper}
-->

# Importing GSEA Data

How would we work with GSEA data? We are going to assume that we are working with the simple text results (what GSEA reports as .xls) from GSEA. We are using the results from the same comparison performed in the `EnrichmentMap` tutorial for GSEA. We should note that the results files generated were generated by R.M. Flight on Feb 17, 2014, but the input files were downloaded from the EnrichmentMap website.

```{r locData}
fileLoc <- system.file("extdata", package="categoryComparePaper")
```

## Import GMT

We first need to be able to import GSEA's `gmt` files that define the gene sets. The actual names of the gene sets are not very appropriate for use as direct names in `R`, so they are assigned numerical entries instead, and the full label and description is stored.

```{r draftGMT}
gmtfile <- file.path(fileLoc, "Human_GO_AllPathways_no_GO_iea_April_15_2013_symbol.gmt.gz")
readGMT <- function(gmtfile){
  gmtContents <- scan(gmtfile, what="char", sep="\n", encoding="latin1")
  nSet <- length(gmtContents)
  gmtID <- as.character(seq(1, nSet))
  oldID <- character(nSet)
  gmtDesc <- character(nSet)
  
  gmtSplit <- strsplit(gmtContents, "\t", fixed=F)
    
  gmtData <- lapply(seq(1, nSet), function(inLoc){
    oldID[inLoc] <<- gmtSplit[[inLoc]][1]
    gmtDesc[inLoc] <<- paste(gmtSplit[[inLoc]][1], gmtSplit[[inLoc]][2], sep="::")
    nSplit <- length(gmtSplit[[inLoc]])
    unique(gmtSplit[[inLoc]][seq(3, nSplit)])
  })
  names(gmtData) <- gmtID
  old2new <- gmtID
  names(old2new) <- toupper(oldID)
  names(gmtDesc) <- gmtID
  return(list(id=gmtID, old2new=old2new, description=gmtDesc, data=gmtData))
}
gmtData <- readGMT(gmtfile)
```

## Import Results

This is very important for importing the `GSEA` results files. `GSEA` will output two files for each comparison. In this example, we did the comparison of **estrogen** (ES) to **no-treatment** (NT) for both the 12 and 24 hour time points. `GSEA` reported two files for both, one with gene-sets associated with **estrogen** and associated with **no-treatment**. The **estrogen** results have positive enrichment scores, i.e. they are positively associated with the comparison, and the **no-treatment** results have negative enrichment scores, i.e. they are negatively associated with the comparison. 

**It is up to the user** to associate proper conditions to each file in each comparison! In this example, we have given the designations of Up and Down based on the explanation above. 

Note that we define the files, and we also define which statistic to use (the default is `NOM p-val`), and what the cutoff value is to consider something important.

```{r readResults}
fileList <- list(ES12.Down="gsea_nt12_results.xls",
                 ES12.Up="gsea_es12_results.xls",
                 ES24.Down="gsea_nt24_results.xls",
                 ES24.Up="gsea_es24_results.xls")
fileList <- lapply(fileList, function(x){file.path(fileLoc, x)})

readGSEAResults <- function(fileList, old2new, pUse="NOM p-val", pCut=0.01){
  pUse <- make.names(pUse)
  outResults <- lapply(fileList, function(x){
    tmpRes <- read.table(x, header=TRUE, sep="\t", quote="", stringsAsFactors=FALSE)
    sigLoc <- which(names(tmpRes) %in% pUse)
    sigEntry <- tmpRes[,sigLoc] <= pCut
    sigID <- tmpRes[sigEntry, 'NAME']
    newID <- old2new[sigID]
    names(newID) <- NULL
    newID <- newID[!is.na(newID)]
    return(new("ccSigList", sigID=newID))
  })
  return(outResults)
}

gseaRes <- readGSEAResults(fileList, gmtData$old2new)
```

## Run categoryCompare

We define the gene to annotation mapping, and define sensible comparisons

```{r runCC}
geneAnnMapping <- new("namedList", .Data=gmtData$data, names=names(gmtData$data))
ccGSEA <- new("GENccEnrichResult", gseaRes, categoryName="gsea", geneAnnMapping=geneAnnMapping, overlapType="overlap", annDescription=gmtData$description)

gseaOpts <- new("ccOptions", listNames=names(ccGSEA), compareNames=c("ES12.Up",
                                                                     "ES12.Down",
                                                                     "ES24.Up",
                                                                     "ES24.Down",
                                                                     "ES12.Up,ES24.Up",
                                                                     "ES12.Up,ES24.Down",
                                                                     "ES12.Down,ES24.Up",
                                                                     "ES12.Down,ES24.Down"))
compGSEA <- ccCompare(ccGSEA, gseaOpts)
compGSEA

# break some edges
compGSEA <- breakEdges(compGSEA, 0.8)
compGSEA
```

## Visualize the results

```{r visResults, eval=FALSE}

cwGSEA <- ccOutCyt(compGSEA, gseaOpts, postText="GSEA", rpcPort=9001)
breakEdges(cwGSEA, 0.9)
```

